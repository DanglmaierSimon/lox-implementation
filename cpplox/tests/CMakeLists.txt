cmake_minimum_required(VERSION 3.14)

FetchContent_Declare(googletest
        GIT_REPOSITORY https://github.com/google/googletest.git
        GIT_TAG main)

set(BUILD_GMOCK ON CACHE BOOL "" FORCE)
set(BUILD_GTEST ON CACHE BOOL "" FORCE)
set(INSTALL_GTEST OFF)
set(BUILD_SHARED_LIBS ON CACHE BOOL "" FORCE)

FetchContent_MakeAvailable(googletest)

add_subdirectory(helpers)

function(register_autogen_tests TEST_NAME)
    message(DEBUG "Adding autogenerated test ${TEST_NAME} ...")
    set(SOURCE autogen/${TEST_NAME}.cpp)
    add_executable(${TEST_NAME} ${SOURCE})

    target_compile_options(${TEST_NAME} PRIVATE     
    -Wall
    -Wextra
    -Werror
    -pedantic
    -std=c++17
    -Wshadow
    -Wuninitialized
    -Wno-c++98-compat
    -Wno-unused
    -Wno-c99-designator
    -Wimplicit-fallthrough
    -Wempty-body
    -Wno-c99-extensions
    -fPIC
    ${SANITIZER_COMPILE_FLAGS})

    target_link_libraries(${TEST_NAME} PUBLIC lox testlib gtest_main gmock)

    target_link_options(${TEST_NAME} PRIVATE ${SANITIZER_LINK_FLAGS})

    include(GoogleTest)
    gtest_discover_tests(${TEST_NAME})
endfunction()

function (register_test TEST_NAME)

    message(DEBUG "Adding test ${TEST_NAME} ...")

    include(GoogleTest)

    add_executable(${TEST_NAME} ${TEST_NAME}.cpp)
    target_link_libraries(${TEST_NAME} PUBLIC lox testlib gtest_main gmock)

    target_compile_options(${TEST_NAME} PRIVATE     
    -Wall
    -Wextra
    -Werror
    -pedantic
    -std=c++17
    -Wshadow
    -Wuninitialized
    -Wno-c++98-compat
    -Wno-unused
    -Wno-c99-designator
    -Wimplicit-fallthrough
    -Wempty-body
    -Wno-c99-extensions
    -fPIC
    ${SANITIZER_COMPILE_FLAGS})

    target_link_options(${TEST_NAME} PRIVATE ${SANITIZER_LINK_FLAGS})

    gtest_discover_tests(${TEST_NAME})

endfunction()

set(AUTOGEN_TESTS
    test_block
    test_call 
    test_closure 
    test_constructor
    test_field
    test_function
    test_inheritance
    test_logical_operator
    test_misc
    test_number  
    test_print     
    test_return  
    test_string
    test_this    
    test_while
    test_assignment
    test_bool 
    test_class
    test_comments
    # test_expressions # Only useful for early chapters
    test_for  
    test_if      
    test_limit      
    test_method          
    test_nil 
    test_operator
    test_regression
    # test_scanning # only useful for early chapters
    test_super 
    test_variable
)

message (STATUS "Registering autogenerated tests ...")
foreach(test ${AUTOGEN_TESTS})
    register_autogen_tests(${test})
endforeach()

set(TESTS 
    test_scanner
)

message (STATUS "Registering tests ...")
foreach(test ${TESTS})
    register_test(${test})
endforeach()

